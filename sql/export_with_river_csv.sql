\copy ( SELECT s.name AS station_name, s.lat AS station_lat, s.lon AS station_lon, nr.name AS nearest_river, p.name AS pub_name, p.lat AS pub_lat, p.lon AS pub_lon, ST_Distance(s.geom, p.geom) AS distance_to_pub_m FROM ( SELECT DISTINCT s.* FROM train_stations s JOIN rivers r ON ST_DWithin(s.geom, r.geom, 2000) WHERE s.lat < 52.2053) s JOIN LATERAL ( SELECT r.name FROM rivers r ORDER BY s.geom <-> r.geom LIMIT 1) nr ON TRUE JOIN LATERAL ( SELECT p.* FROM pubs p ORDER BY s.geom <-> p.geom LIMIT 5) p ON TRUE ORDER BY s.name, distance_to_pub_m) TO 'station_pubs_with_river.csv' WITH CSV HEADER;
